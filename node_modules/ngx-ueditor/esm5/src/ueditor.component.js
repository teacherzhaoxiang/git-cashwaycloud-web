import { Component, Input, forwardRef, EventEmitter, Output, ChangeDetectionStrategy, ChangeDetectorRef, NgZone, } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { ScriptService } from './script.service';
import { UEditorConfig } from './ueditor.config';
var _hook_finished = false;
var UEditorComponent = /** @class */ (function () {
    function UEditorComponent(ss, cog, cd, zone) {
        this.ss = ss;
        this.cog = cog;
        this.cd = cd;
        this.zone = zone;
        this.inited = false;
        this.events = {};
        this.loading = true;
        this.id = "_ueditor-" + Math.random()
            .toString(36)
            .substring(2);
        this.loadingTip = '加载中...';
        this._disabled = false;
        /** 延迟初始化 */
        this.delay = 50;
        this.onPreReady = new EventEmitter();
        this.onReady = new EventEmitter();
        this.onDestroy = new EventEmitter();
    }
    Object.defineProperty(UEditorComponent.prototype, "disabled", {
        set: function (value) {
            this._disabled = value;
            this.setDisabled();
        },
        enumerable: true,
        configurable: true
    });
    UEditorComponent.prototype.ngOnInit = function () {
        this.inited = true;
    };
    UEditorComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        // 已经存在对象无须进入懒加载模式
        if (window.UE) {
            this.initDelay();
            return;
        }
        this.ss
            .load(this.cog.js)
            .getChangeEmitter()
            .subscribe(function (res) {
            _this.initDelay();
        });
    };
    UEditorComponent.prototype.ngOnChanges = function (changes) {
        if (this.inited && changes.config) {
            this.destroy();
            this.initDelay();
        }
    };
    UEditorComponent.prototype.initDelay = function () {
        var _this = this;
        setTimeout(function () { return _this.init(); }, this.delay);
    };
    UEditorComponent.prototype.init = function () {
        var _this = this;
        if (!window.UE)
            throw new Error('uedito js文件加载失败');
        if (this.instance)
            return;
        // registrer hook
        if (this.cog.hook && !_hook_finished) {
            _hook_finished = true;
            this.cog.hook(UE);
        }
        this.onPreReady.emit(this);
        var opt = Object.assign({}, this.cog.options, this.config);
        this.zone.runOutsideAngular(function () {
            var ueditor = UE.getEditor(_this.id, opt);
            ueditor.ready(function () {
                _this.instance = ueditor;
                if (_this.value)
                    _this.instance.setContent(_this.value);
                _this.onReady.emit(_this);
            });
            ueditor.addListener('contentChange', function () {
                _this.value = ueditor.getContent();
                _this.zone.run(function () { return _this.onChange(_this.value); });
            });
        });
        this.loading = false;
        this.cd.detectChanges();
    };
    UEditorComponent.prototype.destroy = function () {
        var _this = this;
        if (this.instance) {
            this.zone.runOutsideAngular(function () {
                Object.keys(_this.events).forEach(function (name) {
                    return _this.instance.removeListener(name, _this.events[name]);
                });
                _this.instance.removeListener('ready');
                _this.instance.removeListener('contentChange');
                _this.instance.destroy();
                _this.instance = null;
            });
        }
        this.onDestroy.emit();
    };
    UEditorComponent.prototype.setDisabled = function () {
        if (!this.instance)
            return;
        if (this._disabled) {
            this.instance.setDisabled();
        }
        else {
            this.instance.setEnabled();
        }
    };
    Object.defineProperty(UEditorComponent.prototype, "Instance", {
        /**
         * 获取UE实例
         *
         * @readonly
         */
        get: function () {
            return this.instance;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 设置编辑器语言
     */
    UEditorComponent.prototype.setLanguage = function (lang) {
        var _this = this;
        this.ss
            .loadScript(this.cog.options.UEDITOR_HOME_URL + "/lang/" + lang + "/" + lang + ".js")
            .then(function (res) {
            _this.destroy();
            // 清空语言
            if (!UE._bak_I18N) {
                UE._bak_I18N = UE.I18N;
            }
            UE.I18N = {};
            UE.I18N[lang] = UE._bak_I18N[lang];
            _this.initDelay();
        });
    };
    /**
     * 添加编辑器事件
     */
    UEditorComponent.prototype.addListener = function (eventName, fn) {
        if (this.events[eventName])
            return;
        this.events[eventName] = fn;
        this.instance.addListener(eventName, fn);
    };
    /**
     * 移除编辑器事件
     */
    UEditorComponent.prototype.removeListener = function (eventName) {
        if (!this.events[eventName])
            return;
        this.instance.removeListener(eventName, this.events[eventName]);
        delete this.events[eventName];
    };
    UEditorComponent.prototype.ngOnDestroy = function () {
        this.destroy();
    };
    // reuse-tab: http://ng-alain.com/components/reuse-tab#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F
    UEditorComponent.prototype._onReuseInit = function () {
        this.destroy();
        this.initDelay();
    };
    UEditorComponent.prototype.writeValue = function (value) {
        this.value = value;
        if (this.instance) {
            this.instance.setContent(this.value);
        }
    };
    UEditorComponent.prototype.registerOnChange = function (fn) {
        this.onChange = fn;
    };
    UEditorComponent.prototype.registerOnTouched = function (fn) {
        this.onTouched = fn;
    };
    UEditorComponent.prototype.setDisabledState = function (isDisabled) {
        this.disabled = isDisabled;
        this.setDisabled();
    };
    UEditorComponent.decorators = [
        { type: Component, args: [{
                    selector: 'ueditor',
                    template: "\n  <textarea id=\"{{id}}\" class=\"ueditor-textarea\"></textarea>\n  <div *ngIf=\"loading\" class=\"loading\" [innerHTML]=\"loadingTip\"></div>\n  ",
                    preserveWhitespaces: false,
                    providers: [
                        {
                            provide: NG_VALUE_ACCESSOR,
                            useExisting: forwardRef(function () { return UEditorComponent; }),
                            multi: true,
                        },
                    ],
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    styles: ["\n      :host {\n        line-height: initial;\n      }\n      :host .ueditor-textarea {\n        display: none;\n      }\n    "]
                }] }
    ];
    /** @nocollapse */
    UEditorComponent.ctorParameters = function () { return [
        { type: ScriptService },
        { type: UEditorConfig },
        { type: ChangeDetectorRef },
        { type: NgZone }
    ]; };
    UEditorComponent.propDecorators = {
        config: [{ type: Input }],
        loadingTip: [{ type: Input }],
        disabled: [{ type: Input }],
        delay: [{ type: Input }],
        onPreReady: [{ type: Output }],
        onReady: [{ type: Output }],
        onDestroy: [{ type: Output }]
    };
    return UEditorComponent;
}());
export { UEditorComponent };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWVkaXRvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtdWVkaXRvci8iLCJzb3VyY2VzIjpbInNyYy91ZWRpdG9yLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULEtBQUssRUFDTCxVQUFVLEVBRVYsWUFBWSxFQUNaLE1BQU0sRUFFTix1QkFBdUIsRUFDdkIsaUJBQWlCLEVBSWpCLE1BQU0sR0FDUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsaUJBQWlCLEVBQXdCLE1BQU0sZ0JBQWdCLENBQUM7QUFFekUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUlqRCxJQUFJLGNBQWMsR0FBRyxLQUFLLENBQUM7QUFtQjNCO0lBK0RFLDBCQUNVLEVBQWlCLEVBQ2pCLEdBQWtCLEVBQ2xCLEVBQXFCLEVBQ3JCLElBQVk7UUFIWixPQUFFLEdBQUYsRUFBRSxDQUFlO1FBQ2pCLFFBQUcsR0FBSCxHQUFHLENBQWU7UUFDbEIsT0FBRSxHQUFGLEVBQUUsQ0FBbUI7UUFDckIsU0FBSSxHQUFKLElBQUksQ0FBUTtRQXJDZCxXQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ2YsV0FBTSxHQUFRLEVBQUUsQ0FBQztRQUt6QixZQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ2YsT0FBRSxHQUFHLGNBQVksSUFBSSxDQUFDLE1BQU0sRUFBRTthQUMzQixRQUFRLENBQUMsRUFBRSxDQUFDO2FBQ1osU0FBUyxDQUFDLENBQUMsQ0FBRyxDQUFDO1FBS2xCLGVBQVUsR0FBRyxRQUFRLENBQUM7UUFNZCxjQUFTLEdBQUcsS0FBSyxDQUFDO1FBRTFCLFlBQVk7UUFFWixVQUFLLEdBQUcsRUFBRSxDQUFDO1FBR0YsZUFBVSxHQUFHLElBQUksWUFBWSxFQUFvQixDQUFDO1FBRWxELFlBQU8sR0FBRyxJQUFJLFlB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QUF1QixDQUFDLE1BQU07NkJBaEI3QyxpSUFPQztpQkFVSjs7OztnQkFqRFEsYUFBYTtnQkFDYixhQUFhO2dCQVRwQixpQkFBaUI7Z0JBSWpCLE1BQU07Ozt5QkFxRUwsS0FBSzs2QkFFTCxLQUFLOzJCQUVMLEtBQUs7d0JBUUwsS0FBSzs2QkFHTCxNQUFNOzBCQUVOLE1BQU07NEJBRU4sTUFBTTs7SUE4S1QsdUJBQUM7Q0FBQSxBQTFPRCxJQTBPQztTQWhOWSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIENvbXBvbmVudCxcclxuICBJbnB1dCxcclxuICBmb3J3YXJkUmVmLFxyXG4gIE9uRGVzdHJveSxcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgT3V0cHV0LFxyXG4gIE9uSW5pdCxcclxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcclxuICBDaGFuZ2VEZXRlY3RvclJlZixcclxuICBBZnRlclZpZXdJbml0LFxyXG4gIE9uQ2hhbmdlcyxcclxuICBTaW1wbGVDaGFuZ2VzLFxyXG4gIE5nWm9uZSxcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTkdfVkFMVUVfQUNDRVNTT1IsIENvbnRyb2xWYWx1ZUFjY2Vzc29yIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5cclxuaW1wb3J0IHsgU2NyaXB0U2VydmljZSB9IGZyb20gJy4vc2NyaXB0LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBVRWRpdG9yQ29uZmlnIH0gZnJvbSAnLi91ZWRpdG9yLmNvbmZpZyc7XHJcblxyXG5kZWNsYXJlIGNvbnN0IHdpbmRvdzogYW55O1xyXG5kZWNsYXJlIGNvbnN0IFVFOiBhbnk7XHJcbmxldCBfaG9va19maW5pc2hlZCA9IGZhbHNlO1xyXG5cclxuZXhwb3J0IHR5cGUgRXZlbnRUeXBlcyA9XHJcbiAgfCAnZGVzdHJveSdcclxuICB8ICdyZXNldCdcclxuICB8ICdmb2N1cydcclxuICB8ICdsYW5nUmVhZHknXHJcbiAgfCAnYmVmb3JlRXhlY0NvbW1hbmQnXHJcbiAgfCAnYWZ0ZXJFeGVjQ29tbWFuZCdcclxuICB8ICdmaXJzdEJlZm9yZUV4ZWNDb21tYW5kJ1xyXG4gIHwgJ2JlZm9yZUdldENvbnRlbnQnXHJcbiAgfCAnYWZ0ZXJHZXRDb250ZW50J1xyXG4gIHwgJ2dldEFsbEh0bWwnXHJcbiAgfCAnYmVmb3JlU2V0Q29udGVudCdcclxuICB8ICdhZnRlclNldENvbnRlbnQnXHJcbiAgfCAnc2VsZWN0aW9uY2hhbmdlJ1xyXG4gIHwgJ2JlZm9yZVNlbGVjdGlvbkNoYW5nZSdcclxuICB8ICdhZnRlclNlbGVjdGlvbkNoYW5nZSc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3VlZGl0b3InLFxyXG4gIHRlbXBsYXRlOiBgXHJcbiAgPHRleHRhcmVhIGlkPVwie3tpZH19XCIgY2xhc3M9XCJ1ZWRpdG9yLXRleHRhcmVhXCI+PC90ZXh0YXJlYT5cclxuICA8ZGl2ICpuZ0lmPVwibG9hZGluZ1wiIGNsYXNzPVwibG9hZGluZ1wiIFtpbm5lckhUTUxdPVwibG9hZGluZ1RpcFwiPjwvZGl2PlxyXG4gIGAsXHJcbiAgcHJlc2VydmVXaGl0ZXNwYWNlczogZmFsc2UsXHJcbiAgc3R5bGVzOiBbXHJcbiAgICBgXHJcbiAgICAgIDpob3N0IHtcclxuICAgICAgICBsaW5lLWhlaWdodDogaW5pdGlhbDtcclxuICAgICAgfVxyXG4gICAgICA6aG9zdCAudWVkaXRvci10ZXh0YXJlYSB7XHJcbiAgICAgICAgZGlzcGxheTogbm9uZTtcclxuICAgICAgfVxyXG4gICAgYCxcclxuICBdLFxyXG4gIHByb3ZpZGVyczogW1xyXG4gICAge1xyXG4gICAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcclxuICAgICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gVUVkaXRvckNvbXBvbmVudCksXHJcbiAgICAgIG11bHRpOiB0cnVlLFxyXG4gICAgfSxcclxuICBdLFxyXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgVUVkaXRvckNvbXBvbmVudFxyXG4gIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSwgQ29udHJvbFZhbHVlQWNjZXNzb3Ige1xyXG4gIHByaXZhdGUgaW5zdGFuY2U6IGFueTtcclxuICBwcml2YXRlIHZhbHVlOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBpbml0ZWQgPSBmYWxzZTtcclxuICBwcml2YXRlIGV2ZW50czogYW55ID0ge307XHJcblxyXG4gIHByaXZhdGUgb25DaGFuZ2U6ICh2YWx1ZTogc3RyaW5nKSA9PiB2b2lkO1xyXG4gIHByaXZhdGUgb25Ub3VjaGVkOiAoKSA9PiB2b2lkO1xyXG5cclxuICBsb2FkaW5nID0gdHJ1ZTtcclxuICBpZCA9IGBfdWVkaXRvci0ke01hdGgucmFuZG9tKClcclxuICAgIC50b1N0cmluZygzNilcclxuICAgIC5zdWJzdHJpbmcoMil9YDtcclxuXHJcbiAgQElucHV0KClcclxuICBjb25maWc6IGFueTtcclxuICBASW5wdXQoKVxyXG4gIGxvYWRpbmdUaXAgPSAn5Yqg6L295LitLi4uJztcclxuICBASW5wdXQoKVxyXG4gIHNldCBkaXNhYmxlZCh2YWx1ZTogYm9vbGVhbikge1xyXG4gICAgdGhpcy5fZGlzYWJsZWQgPSB2YWx1ZTtcclxuICAgIHRoaXMuc2V0RGlzYWJsZWQoKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBfZGlzYWJsZWQgPSBmYWxzZTtcclxuXHJcbiAgLyoqIOW7tui/n+WIneWni+WMliAqL1xyXG4gIEBJbnB1dCgpXHJcbiAgZGVsYXkgPSA1MDtcclxuXHJcbiAgQE91dHB1dCgpXHJcbiAgcmVhZG9ubHkgb25QcmVSZWFkeSA9IG5ldyBFdmVudEVtaXR0ZXI8VUVkaXRvckNvbXBvbmVudD4oKTtcclxuICBAT3V0cHV0KClcclxuICByZWFkb25seSBvblJlYWR5ID0gbmV3IEV2ZW50RW1pdHRlcjxVRWRpdG9yQ29tcG9uZW50PigpO1xyXG4gIEBPdXRwdXQoKVxyXG4gIHJlYWRvbmx5IG9uRGVzdHJveSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHNzOiBTY3JpcHRTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBjb2c6IFVFZGl0b3JDb25maWcsXHJcbiAgICBwcml2YXRlIGNkOiBDaGFuZ2VEZXRlY3RvclJlZixcclxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxyXG4gICkge31cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLmluaXRlZCA9IHRydWU7XHJcbiAgfVxyXG5cclxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICAvLyDlt7Lnu4/lrZjlnKjlr7nosaHml6Dpobvov5vlhaXmh5LliqDovb3mqKHlvI9cclxuICAgIGlmICh3aW5kb3cuVUUpIHtcclxuICAgICAgdGhpcy5pbml0RGVsYXkoKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuc3NcclxuICAgICAgLmxvYWQodGhpcy5jb2cuanMpXHJcbiAgICAgIC5nZXRDaGFuZ2VFbWl0dGVyKClcclxuICAgICAgLnN1YnNjcmliZShyZXMgPT4ge1xyXG4gICAgICAgIHRoaXMuaW5pdERlbGF5KCk7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuaW5pdGVkICYmIGNoYW5nZXMuY29uZmlnKSB7XHJcbiAgICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gICAgICB0aGlzLmluaXREZWxheSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0RGVsYXkoKSB7XHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuaW5pdCgpLCB0aGlzLmRlbGF5KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdCgpIHtcclxuICAgIGlmICghd2luZG93LlVFKSB0aHJvdyBuZXcgRXJyb3IoJ3VlZGl0byBqc+aWh+S7tuWKoOi9veWksei0pScpO1xyXG5cclxuICAgIGlmICh0aGlzLmluc3RhbmNlKSByZXR1cm47XHJcblxyXG4gICAgLy8gcmVnaXN0cmVyIGhvb2tcclxuICAgIGlmICh0aGlzLmNvZy5ob29rICYmICFfaG9va19maW5pc2hlZCkge1xyXG4gICAgICBfaG9va19maW5pc2hlZCA9IHRydWU7XHJcbiAgICAgIHRoaXMuY29nLmhvb2soVUUpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMub25QcmVSZWFkeS5lbWl0KHRoaXMpO1xyXG5cclxuICAgIGNvbnN0IG9wdCA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuY29nLm9wdGlvbnMsIHRoaXMuY29uZmlnKTtcclxuXHJcbiAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICBjb25zdCB1ZWRpdG9yID0gVUUuZ2V0RWRpdG9yKHRoaXMuaWQsIG9wdCk7XHJcbiAgICAgIHVlZGl0b3IucmVhZHkoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UgPSB1ZWRpdG9yO1xyXG4gICAgICAgIGlmICh0aGlzLnZhbHVlKSB0aGlzLmluc3RhbmNlLnNldENvbnRlbnQodGhpcy52YWx1ZSk7XHJcbiAgICAgICAgdGhpcy5vblJlYWR5LmVtaXQodGhpcyk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdWVkaXRvci5hZGRMaXN0ZW5lcignY29udGVudENoYW5nZScsICgpID0+IHtcclxuICAgICAgICB0aGlzLnZhbHVlID0gdWVkaXRvci5nZXRDb250ZW50KCk7XHJcblxyXG4gICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4gdGhpcy5vbkNoYW5nZSh0aGlzLnZhbHVlKSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcclxuICAgIHRoaXMuY2QuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkZXN0cm95KCkge1xyXG4gICAgaWYgKHRoaXMuaW5zdGFuY2UpIHtcclxuICAgICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLmV2ZW50cykuZm9yRWFjaChuYW1lID0+XHJcbiAgICAgICAgICB0aGlzLmluc3RhbmNlLnJlbW92ZUxpc3RlbmVyKG5hbWUsIHRoaXMuZXZlbnRzW25hbWVdKSxcclxuICAgICAgICApO1xyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UucmVtb3ZlTGlzdGVuZXIoJ3JlYWR5Jyk7XHJcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5yZW1vdmVMaXN0ZW5lcignY29udGVudENoYW5nZScpO1xyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UuZGVzdHJveSgpO1xyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UgPSBudWxsO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHRoaXMub25EZXN0cm95LmVtaXQoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0RGlzYWJsZWQoKSB7XHJcbiAgICBpZiAoIXRoaXMuaW5zdGFuY2UpIHJldHVybjtcclxuICAgIGlmICh0aGlzLl9kaXNhYmxlZCkge1xyXG4gICAgICB0aGlzLmluc3RhbmNlLnNldERpc2FibGVkKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmluc3RhbmNlLnNldEVuYWJsZWQoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPllVF5a6e5L6LXHJcbiAgICpcclxuICAgKiBAcmVhZG9ubHlcclxuICAgKi9cclxuICBnZXQgSW5zdGFuY2UoKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLmluc3RhbmNlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572u57yW6L6R5Zmo6K+t6KiAXHJcbiAgICovXHJcbiAgc2V0TGFuZ3VhZ2UobGFuZzogJ3poLWNuJyB8ICdlbicpIHtcclxuICAgIHRoaXMuc3NcclxuICAgICAgLmxvYWRTY3JpcHQoXHJcbiAgICAgICAgYCR7dGhpcy5jb2cub3B0aW9ucy5VRURJVE9SX0hPTUVfVVJMfS9sYW5nLyR7bGFuZ30vJHtsYW5nfS5qc2AsXHJcbiAgICAgIClcclxuICAgICAgLnRoZW4ocmVzID0+IHtcclxuICAgICAgICB0aGlzLmRlc3Ryb3koKTtcclxuXHJcbiAgICAgICAgLy8g5riF56m66K+t6KiAXHJcbiAgICAgICAgaWYgKCFVRS5fYmFrX0kxOE4pIHtcclxuICAgICAgICAgIFVFLl9iYWtfSTE4TiA9IFVFLkkxOE47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFVFLkkxOE4gPSB7fTtcclxuICAgICAgICBVRS5JMThOW2xhbmddID0gVUUuX2Jha19JMThOW2xhbmddO1xyXG5cclxuICAgICAgICB0aGlzLmluaXREZWxheSgpO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOe8lui+keWZqOS6i+S7tlxyXG4gICAqL1xyXG4gIGFkZExpc3RlbmVyKGV2ZW50TmFtZTogRXZlbnRUeXBlcywgZm46IEZ1bmN0aW9uKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5ldmVudHNbZXZlbnROYW1lXSkgcmV0dXJuO1xyXG4gICAgdGhpcy5ldmVudHNbZXZlbnROYW1lXSA9IGZuO1xyXG4gICAgdGhpcy5pbnN0YW5jZS5hZGRMaXN0ZW5lcihldmVudE5hbWUsIGZuKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOenu+mZpOe8lui+keWZqOS6i+S7tlxyXG4gICAqL1xyXG4gIHJlbW92ZUxpc3RlbmVyKGV2ZW50TmFtZTogRXZlbnRUeXBlcyk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmV2ZW50c1tldmVudE5hbWVdKSByZXR1cm47XHJcbiAgICB0aGlzLmluc3RhbmNlLnJlbW92ZUxpc3RlbmVyKGV2ZW50TmFtZSwgdGhpcy5ldmVudHNbZXZlbnROYW1lXSk7XHJcbiAgICBkZWxldGUgdGhpcy5ldmVudHNbZXZlbnROYW1lXTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgfVxyXG5cclxuICAvLyByZXVzZS10YWI6IGh0dHA6Ly9uZy1hbGFpbi5jb20vY29tcG9uZW50cy9yZXVzZS10YWIjJUU3JTk0JTlGJUU1JTkxJUJEJUU1JTkxJUE4JUU2JTlDJTlGXHJcbiAgX29uUmV1c2VJbml0KCkge1xyXG4gICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICB0aGlzLmluaXREZWxheSgpO1xyXG4gIH1cclxuXHJcbiAgd3JpdGVWYWx1ZSh2YWx1ZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnZhbHVlID0gdmFsdWU7XHJcbiAgICBpZiAodGhpcy5pbnN0YW5jZSkge1xyXG4gICAgICB0aGlzLmluc3RhbmNlLnNldENvbnRlbnQodGhpcy52YWx1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWdpc3Rlck9uQ2hhbmdlKGZuOiAoXzogYW55KSA9PiB7fSk6IHZvaWQge1xyXG4gICAgdGhpcy5vbkNoYW5nZSA9IGZuO1xyXG4gIH1cclxuICByZWdpc3Rlck9uVG91Y2hlZChmbjogKCkgPT4ge30pOiB2b2lkIHtcclxuICAgIHRoaXMub25Ub3VjaGVkID0gZm47XHJcbiAgfVxyXG5cclxuICBzZXREaXNhYmxlZFN0YXRlKGlzRGlzYWJsZWQ6IGJvb2xlYW4pOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzYWJsZWQgPSBpc0Rpc2FibGVkO1xyXG4gICAgdGhpcy5zZXREaXNhYmxlZCgpO1xyXG4gIH1cclxufVxyXG4iXX0=